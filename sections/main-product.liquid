{% comment %}
  Pixel-Perfect Main Product Section - Juice Can Theme
  Matches exact visual reference: Vertical thumbs, Circular Swatches, Pack Pills, Feature Icons
{% endcomment %}

{{ 'section-main-product.css' | asset_url | stylesheet_tag }}
<script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

{% comment %}
  Dynamic background color from variant metafield, fallback to product metafield
{% endcomment %}
{% assign selected_variant = product.selected_or_first_available_variant %}
{% assign variant_bg_color = selected_variant.metafields.custom.color %}
{% assign bg_color = variant_bg_color | default: product.metafields.custom.background_color | default: '#E6F4EA' %}
{% assign variant_feature_color = selected_variant.metafields.custom.feature_color %}
{% assign feature_color = variant_feature_color | default: product.metafields.custom.feature_color | default: '#1A4D3E' %}

<section class="pp-product-section" style="--pp-bg: {{ bg_color }}; --pp-feature-color: {{ feature_color }};" data-section-id="{{ section.id }}" data-variant-colors='{% for variant in product.variants %}"{{ variant.id }}":{"bg":"{{ variant.metafields.custom.color | default: bg_color }}","feature":"{{ variant.metafields.custom.feature_color | default: feature_color }}"}{% unless forloop.last %},{% endunless %}{% endfor %}'>
  <div class="pp-container">
    <div class="pp-grid">
      
      <!-- LEFT COLUMN: Simple Vertical Gallery -->
      <div class="pp-gallery">
        <div class="pp-gallery-inner">
          
          <!-- Thumbnails (Vertical Left) -->
          {% if product.images.size > 1 %}
            <div class="pp-thumbnails">
              {% for image in product.images %}
                <div 
                  class="pp-thumbnail {% if forloop.first %}active{% endif %}"
                  data-target-image="{{ image | image_url: width: 800 }}"
                >
                  <img src="{{ image | image_url: width: 150 }}" alt="{{ image.alt | escape }}" loading="lazy">
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <!-- Main Image -->
          <div class="pp-main-image-wrapper">
             <img 
               id="MainProductImage-{{ section.id }}"
               src="{{ product.featured_image | image_url: width: 1000 }}" 
               alt="{{ product.title | escape }}"
               class="pp-main-image"
               loading="eager"
             >
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Product Info -->
      <div class="pp-info">
        
        <!-- Star Rating -->
        <div class="pp-rating">
          <span class="pp-stars">★★★★★</span>
          <span class="pp-review-count">50 Reviews</span>
        </div>

        <!-- Title & Tagline -->
        <h1 class="pp-title">{{ product.title }}</h1>
        {% if product.metafields.custom.tagline %}
          <p class="pp-tagline">{{ product.metafields.custom.tagline }}</p>
        {% else %}
          <p class="pp-tagline">TANGY. NOSTALGIC. UNEXPECTED.</p>
        {% endif %}

        <!-- Feature Icons Row -->
        <div class="pp-features-row">
            <div class="pp-feature-item">
                <div class="pp-feature-icon">
                    <img src="{{ 'spfeature1.svg' | asset_url }}" alt="Real fruit flavour" width="24" height="24">
                </div>
                <span class="pp-feature-text">Real fruit flavour</span>
            </div>
            <div class="pp-feature-item">
                <div class="pp-feature-icon">
                    <img src="{{ 'spfeature2.svg' | asset_url }}" alt="Prebiotic fibre" width="24" height="24">
                </div>
                <span class="pp-feature-text">Prebiotic fibre</span>
            </div>
            <div class="pp-feature-item">
                <div class="pp-feature-icon">
                    <img src="{{ 'spfeature3.svg' | asset_url }}" alt="Low sugar" width="24" height="24">
                </div>
                <span class="pp-feature-text">Low sugar</span>
            </div>
            <div class="pp-feature-item">
                <div class="pp-feature-icon">
                    <img src="{{ 'spfeature4.svg' | asset_url }}" alt="No Artificial Additives" width="24" height="24">
                </div>
                <span class="pp-feature-text">No Artificial Additives</span>
            </div>
        </div>

        <div class="pp-separator"></div>

        {%- form 'product', product, id: 'product-form-pp', class: 'pp-form' -%}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

          <!-- Variant Switcher 1: Flavor (Circular) -->
          {% assign flavour_option = product.options_with_values | where: "name", "Flavour" | first %}
          {% unless flavour_option %}
             {% assign flavour_option = product.options_with_values | where: "name", "Flavor" | first %}
          {% endunless %}
          {% unless flavour_option %}
             {% assign flavour_option = product.options_with_values | where: "name", "Color" | first %}
          {% endunless %}
          {% unless flavour_option %}
             {% assign flavour_option = product.options_with_values | where: "name", "Colour" | first %}
          {% endunless %}
          
          {% if flavour_option %}
            <div class="pp-option-group">
                <label class="pp-option-label">Flavour: <span class="pp-flavor-label-val">{{ flavour_option.selected_value }}</span></label>
                <div class="pp-swatches-flavor">
                    {% for value in flavour_option.values %}
                        {% comment %} Find the variant with this flavor value {% endcomment %}
                        {% assign flavor_variant = nil %}
                        {% for variant in product.variants %}
                            {% if variant.option1 == value or variant.option2 == value or variant.option3 == value %}
                                {% assign flavor_variant = variant %}
                                {% break %}
                            {% endif %}
                        {% endfor %}
                        
                        {% comment %} Get the variant image or fallback to product image {% endcomment %}
                        {% if flavor_variant and flavor_variant.featured_image %}
                            {% assign variant_img = flavor_variant.featured_image | image_url: width: 150 %}
                        {% elsif product.featured_image %}
                            {% assign variant_img = product.featured_image | image_url: width: 150 %}
                        {% else %}
                            {% assign variant_img = 'can1.png' | asset_url %}
                        {% endif %}
                        
                        <label class="pp-swatch-flavor-item {% if flavour_option.selected_value == value %}selected{% endif %}">
                            <input type="radio" name="{{ flavour_option.name }}" value="{{ value }}" data-variant-id="{{ flavor_variant.id }}" {% if flavour_option.selected_value == value %}checked{% endif %}>
                            <div class="pp-flavor-circle">
                                <img src="{{ variant_img }}" alt="{{ value }}" class="pp-flavor-img" loading="lazy">
                            </div>
                            <span class="pp-flavor-name">{{ value }}</span>
                        </label>
                    {% endfor %}
                </div>
            </div>
          {% endif %}

          <!-- Variant Switcher 2: Pack Size (Pills) -->
          {% assign pack_option = product.options_with_values | where: "name", "Size" | first %}
          {% unless pack_option %}
             {% assign pack_option = product.options_with_values | where: "name", "Pack" | first %}
          {% endunless %}
          {% unless pack_option %}
             {% assign pack_option = product.options_with_values | where: "name", "Pack Size" | first %}
          {% endunless %}

          {% if pack_option %}
            <div class="pp-option-group">
                <label class="pp-option-label">Select Pack Size</label>
                <div class="pp-swatches-pack">
                    {% for value in pack_option.values %}
                        {% comment %} Find variant for this pack size to get price {% endcomment %}
                        {% assign variant_for_pack = product.variants | where: "option2", value | first %}
                        {% if variant_for_pack == blank %}
                             {% assign variant_for_pack = product.variants | where: "option1", value | first %}
                        {% endif %}
                        
                        <!-- NOTE: Assuming price is dependent on pack size primarily -->
                        
                        <label class="pp-swatch-pack-item {% if pack_option.selected_value == value %}selected{% endif %}">
                             <input type="radio" name="{{ pack_option.name }}" value="{{ value }}" {% if pack_option.selected_value == value %}checked{% endif %}>
                             <span class="pp-pack-name">{% unless value contains 'Pack' %}Pack of {% endunless %}{{ value }}</span>
                             <div class="pp-pack-price-box">
                                 <span class="pp-pack-price">{{ variant_for_pack.price | money_without_trailing_zeros }}</span>
                                 {% if variant_for_pack.compare_at_price > variant_for_pack.price %}
                                    <span class="pp-pack-compare">{{ variant_for_pack.compare_at_price | money_without_trailing_zeros }}</span>
                                 {% endif %}
                             </div>
                        </label>
                    {% endfor %}
                </div>
            </div>
          {% endif %}

          <!-- Fallback for other options -->
          {% for option in product.options_with_values %}
            {% assign opt_name_down = option.name | downcase %}
            {% unless opt_name_down contains 'flavour' or opt_name_down contains 'flavor' or opt_name_down contains 'color' or opt_name_down contains 'colour' or opt_name_down contains 'size' or opt_name_down contains 'pack' %}
              <div class="pp-option-group">
                  <label class="pp-option-label">{{ option.name }}: <span class="pp-flavor-label-val">{{ option.selected_value }}</span></label>
                  <div class="pp-swatches-pack">
                      {% for value in option.values %}
                          <label class="pp-swatch-pack-item {% if option.selected_value == value %}selected{% endif %}" style="justify-content: center; width: auto; min-width: 60px;">
                               <input type="radio" name="{{ option.name }}" value="{{ value }}" {% if option.selected_value == value %}checked{% endif %}>
                               <span class="pp-pack-name">{{ value }}</span>
                          </label>
                      {% endfor %}
                  </div>
              </div>
            {% endunless %}
          {% endfor %}

          {% if product.variants.size <= 1 and product.has_only_default_variant %}
             <p style="color: red; font-size: 14px; margin-bottom: 20px; font-weight: bold; background: #ffe6e6; padding: 10px; border-radius: 8px; border: 1px solid red;">
               [Debug: No variants found. Please add options in Shopify Admin > Products > Variants.]
             </p>
          {% endif %}

          <!-- Add to Cart (Full width black pill) -->
          <button type="submit" name="add" class="pp-add-to-cart" {% unless product.available %}disabled{% endunless %}>
            {% if product.available %}
             ADD TO CART – {{ product.selected_or_first_available_variant.price | money_without_trailing_zeros }}
            {% else %}
             SOLD OUT
            {% endif %}
          </button>
          
          <p class="pp-delivery-note">Delivery expected by 12–15 January</p>

        {%- endform -%}

        <!-- Accordions -->
        <div class="pp-accordions">
            <details class="pp-accordion-item">
                <summary>
                    <span class="pp-accordion-title">Description</span>
                    <span class="pp-icon-chevron"><svg width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                </summary>
                <div class="pp-accordion-content">
                    {{ product.description }}
                </div>
            </details>
            
            <details class="pp-accordion-item">
                <summary>
                    <span class="pp-accordion-title">Storage Tips for Maximum Freshness</span>
                    <span class="pp-icon-chevron"><svg width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                </summary>
                <div class="pp-accordion-content">
                    <p>Keep refrigerated. Serve chilled.</p>
                </div>
            </details>

            <details class="pp-accordion-item">
                <summary>
                    <span class="pp-accordion-title">Ingredients & Nutrition</span>
                    <span class="pp-icon-chevron"><svg width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                </summary>
                <div class="pp-accordion-content">
                    <p>Carbonated Water, Sugar, Fruit Juice Concentrate...</p>
                </div>
            </details>
        </div>

      </div>
    </div>
  </div>
</section>

<style>
/* 
  Ideally move to assets/section-main-product.css
  Keeping here for instant atomic preview if desired, 
  but will move to CSS file in next step.
*/
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const section = document.querySelector('[data-section-id="{{ section.id }}"]');
  
  // Thumbnail Switcher
  const thumbnails = section.querySelectorAll('.pp-thumbnail');
  const mainImage = section.querySelector('.pp-main-image');
  
  thumbnails.forEach(thumb => {
     thumb.addEventListener('mouseenter', function() {
        thumbnails.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        mainImage.src = this.dataset.targetImage;
     });
     
     thumb.addEventListener('click', function() {
        thumbnails.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        mainImage.src = this.dataset.targetImage;
     });
  });
  
  // Variant Logic with color updates
  const variantInputs = section.querySelectorAll('input[type="radio"]');
  const priceBtn = section.querySelector('.pp-add-to-cart');
  
  // Parse variant colors for dynamic background and feature color update
  const variantColorsData = section.dataset.variantColors;
  let variantColors = {};
  try {
      variantColors = JSON.parse('{' + variantColorsData + '}');
  } catch(e) {
      console.log('Could not parse variant colors');
  }
  
  variantInputs.forEach(input => {
      input.addEventListener('change', function() {
          // Update visual selected state
          const group = this.closest('.pp-swatches-flavor') || this.closest('.pp-swatches-pack');
          if (group) {
              group.querySelectorAll('label').forEach(l => l.classList.remove('selected'));
              this.parentElement.classList.add('selected');
          }
          
          // Update background and feature color based on variant selection
          const variantId = this.dataset.variantId;
          if (variantId && variantColors[variantId]) {
              const colors = variantColors[variantId];
              if (colors.bg) {
                  section.style.setProperty('--pp-bg', colors.bg);
              }
              if (colors.feature) {
                  section.style.setProperty('--pp-feature-color', colors.feature);
              }
          }
      });
  });
});
</script>

{% schema %}
{
  "name": "Main Product (Pixel)",
  "settings": [],
  "presets": [
    {
      "name": "Main Product (Pixel)"
    }
  ]
}
{% endschema %}
