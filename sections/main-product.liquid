{% comment %}
  Pixel-Perfect Main Product Section - Juice Can Theme
  Matches exact visual reference: Vertical thumbs, Circular Swatches, Pack Pills, Feature Icons
{% endcomment %}

{{ 'section-main-product.css' | asset_url | stylesheet_tag }}
<script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

{% comment %}
  Dynamic background color from variant metafield, fallback to product metafield
{% endcomment %}
{% assign selected_variant = product.selected_or_first_available_variant %}
{% assign variant_bg_color = selected_variant.metafields.custom.background_color.value %}
{% assign bg_color = variant_bg_color | default: product.metafields.custom.background_color.value | default: '#E6F4EA' %}
{% assign variant_feature_color = selected_variant.metafields.custom.feature_color.value %}
{% assign feature_color = variant_feature_color | default: product.metafields.custom.feature_color.value | default: '#1A4D3E' %}

{% assign variant_heading_color = selected_variant.metafields.custom.heading_color.value %}
{% assign heading_color = variant_heading_color | default: product.metafields.custom.heading_color.value | default: '#000000' %}
{% assign variant_feature_bg = selected_variant.metafields.custom.feature_background_color.value %}
{% assign feature_bg = variant_feature_bg | default: product.metafields.custom.feature_background_color.value | default: '#ffffff' %}

<section class="pp-product-section" style="--pp-bg: {{ bg_color }}; --pp-feature-color: {{ feature_color }}; --pp-heading-color: {{ heading_color }}; --pp-feature-bg: {{ feature_bg }};" data-section-id="{{ section.id }}" data-variant-config='{
  {% for variant in product.variants %}
    "{{ variant.id }}": {
      "bg": "{{ variant.metafields.custom.background_color.value | default: bg_color }}",
      "feature": "{{ variant.metafields.custom.feature_color.value | default: feature_color }}",
      "heading": "{{ variant.metafields.custom.heading_color.value | default: heading_color }}",
      "heading_text": "{{ variant.metafields.custom.product_heading | default: product.title | escape }}",
      "feature_bg": "{{ variant.metafields.custom.feature_background_color.value | default: feature_bg }}",
      "price": {{ variant.price }},
      "compare_at_price": {{ variant.compare_at_price | default: 0 }},
      "available": {{ variant.available }},
      "images": [
        {% assign image_list = variant.metafields.custom.variant_images.value %}
        {% if image_list %}
          {% for img in image_list %}
            "{{ img | image_url: width: 1000 }}"{% unless forloop.last %},{% endunless %}
          {% endfor %}
        {% endif %}
      ],
      "feature_icons": [
        {% assign icon_list = variant.metafields.custom.feature_icons.value %}
        {% if icon_list %}
          {% for icon in icon_list %}
            "{{ icon | image_url }}"{% unless forloop.last %},{% endunless %}
          {% endfor %}
        {% endif %}
      ]
    }{% unless forloop.last %},{% endunless %}
  {% endfor %}
}'>
  <div class="pp-container">
    <div class="pp-grid">
      
      <!-- LEFT COLUMN: Simple Vertical Gallery -->
      <div class="pp-gallery">
        <div class="pp-gallery-inner">
          
          <!-- Thumbnails (Vertical Left) -->
          {% if product.images.size > 1 %}
            <div class="pp-thumbnails">
              {% for image in product.images %}
                {% unless image.alt contains 'variant-swatch-img' %}
                <div 
                  class="pp-thumbnail {% if forloop.first %}active{% endif %}"
                  data-target-image="{{ image | image_url: width: 800 }}"
                >
                  <img src="{{ image | image_url: width: 150 }}" alt="{{ image.alt | escape }}" loading="lazy">
                </div>
                {% endunless %}
              {% endfor %}
            </div>
          {% endif %}

          <!-- Main Image -->
          <div class="pp-main-image-wrapper">
             <img 
               id="MainProductImage-{{ section.id }}"
               src="{{ product.featured_image | image_url: width: 1000 }}" 
               alt="{{ product.title | escape }}"
               class="pp-main-image"
               style="border-radius: 19px;"
               loading="eager"
             >
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Product Info -->
      <div class="pp-info">
        
        <!-- Star Rating -->
        <div class="pp-rating">
          <span class="pp-stars">★★★★★</span>
          <span class="pp-review-count">50 Reviews</span>
        </div>

        <!-- Title & Tagline -->
        <h1 class="pp-title" style="color: var(--pp-heading-color);">{{ product.selected_or_first_available_variant.metafields.custom.product_heading | default: product.title }}</h1>
        {% if product.metafields.custom.tagline %}
          <p class="pp-tagline">{{ product.metafields.custom.tagline }}</p>
        {% else %}
          <p class="pp-tagline">TANGY. NOSTALGIC. UNEXPECTED.</p>
        {% endif %}

        <!-- Feature Icons Row -->
        <div class="pp-features-row">
            <div class="pp-feature-item">
                <div class="pp-feature-icon" style="background: var(--pp-feature-bg);">
                    <img class="pp-feature-icon-img" data-index="0" src="{{ 'spfeature1.svg' | asset_url }}" alt="Real fruit flavour" width="24" height="24">
                </div>
                <span class="pp-feature-text">Real fruit flavour</span>
            </div>
            <div class="pp-feature-item">
                <div class="pp-feature-icon" style="background: var(--pp-feature-bg);">
                    <img class="pp-feature-icon-img" data-index="1" src="{{ 'spfeature2.svg' | asset_url }}" alt="Prebiotic fibre" width="24" height="24">
                </div>
                <span class="pp-feature-text">Prebiotic fibre</span>
            </div>
            <div class="pp-feature-item">
                <div class="pp-feature-icon" style="background: var(--pp-feature-bg);">
                    <img class="pp-feature-icon-img" data-index="2" src="{{ 'spfeature3.svg' | asset_url }}" alt="Low sugar" width="24" height="24">
                </div>
                <span class="pp-feature-text">Low sugar</span>
            </div>
            <div class="pp-feature-item">
                <div class="pp-feature-icon" style="background: var(--pp-feature-bg);">
                    <img class="pp-feature-icon-img" data-index="3" src="{{ 'spfeature4.svg' | asset_url }}" alt="No Artificial Additives" width="24" height="24">
                </div>
                <span class="pp-feature-text">No Artificial Additives</span>
            </div>
        </div>

        <div class="pp-separator"></div>

        {%- form 'product', product, id: 'product-form-pp', class: 'pp-form' -%}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

          <!-- Variant Switcher 1: Flavor (Circular) -->
          {% assign flavour_option = product.options_with_values | where: "name", "Flavour" | first %}
          {% unless flavour_option %}
             {% assign flavour_option = product.options_with_values | where: "name", "Flavor" | first %}
          {% endunless %}
          {% unless flavour_option %}
             {% assign flavour_option = product.options_with_values | where: "name", "Color" | first %}
          {% endunless %}
          {% unless flavour_option %}
             {% assign flavour_option = product.options_with_values | where: "name", "Colour" | first %}
          {% endunless %}
          
          {% if flavour_option %}
            <div class="pp-option-group">
                <label class="pp-option-label">Flavour: <span class="pp-flavor-label-val">{{ flavour_option.selected_value }}</span></label>
                <div class="pp-swatches-flavor">
                    {% for value in flavour_option.values %}
                        {% comment %} Find the variant with this flavor value {% endcomment %}
                        {% assign flavor_variant = false %}
                        {% assign found_flavor = false %}
                        {% for variant in product.variants %}
                            {% if variant.option1 == value or variant.option2 == value or variant.option3 == value %}
                                {% assign flavor_variant = variant %}
                                {% assign found_flavor = true %}
                                {% break %}
                            {% endif %}
                        {% endfor %}
                        
                        {% comment %} Reset image variable, then check swatch metafield {% endcomment %}
                        {% assign variant_img = '' %}
                        {% assign swatch_img = '' %}
                        {% assign meta_images = '' %}

                        {% if found_flavor %}
                            {% assign swatch_img = flavor_variant.metafields.custom.variant_swatch_image.value %}
                            {% assign meta_images = flavor_variant.metafields.custom.variant_images.value %}
                        {% endif %}

                        {% if swatch_img != blank %}
                            {% assign variant_img = swatch_img | image_url: width: 150 %}
                        {% elsif meta_images != blank and meta_images.size > 0 %}
                            {% assign variant_img = meta_images[0] | image_url: width: 150 %}
                        {% elsif found_flavor and flavor_variant.featured_image %}
                            {% assign variant_img = flavor_variant.featured_image | image_url: width: 150 %}
                        {% elsif product.featured_image %}
                            {% assign variant_img = product.featured_image | image_url: width: 150 %}
                        {% else %}
                            {% assign variant_img = 'can1.png' | asset_url %}
                        {% endif %}
                        
                        <label class="pp-swatch-flavor-item {% if flavour_option.selected_value == value %}selected{% endif %}">
                            <input type="radio" name="{{ flavour_option.name }}" value="{{ value }}" data-variant-id="{{ flavor_variant.id }}" {% if flavour_option.selected_value == value %}checked{% endif %}>
                            <div class="pp-flavor-circle">
                                <img src="{{ variant_img }}" alt="{{ value }}" class="pp-flavor-img" loading="lazy">
                            </div>
                            <span class="pp-flavor-name">{{ value }}</span>
                        </label>
                    {% endfor %}
                </div>
            </div>
          {% endif %}

          <!-- Variant Switcher 2: Pack Size (Pills) -->
          {% assign pack_option = nil %}
          {% for option in product.options_with_values %}
            {% assign opt_name = option.name | downcase %}
            {% if opt_name contains 'pack' or opt_name contains 'size' or opt_name contains 'quantity' %}
              {% assign pack_option = option %}
            {% endif %}
          {% endfor %}

          {% if pack_option %}
            <div class="pp-option-group">
                <label class="pp-option-label">Select Pack Size</label>
                <div class="pp-swatches-pack">
                    {% for value in pack_option.values %}
                        {% comment %} Find variant for this pack size to get price {% endcomment %}
                        {% assign variant_for_pack = product.variants | where: "option2", value | first %}
                        {% if variant_for_pack == blank %}
                             {% assign variant_for_pack = product.variants | where: "option1", value | first %}
                        {% endif %}
                        
                        <!-- NOTE: Assuming price is dependent on pack size primarily -->
                        
                         <label class="pp-swatch-pack-item {% if pack_option.selected_value == value %}selected{% endif %}">
                             <input type="radio" name="{{ pack_option.name }}" value="{{ value }}" data-variant-id="{{ variant_for_pack.id }}" {% if pack_option.selected_value == value %}checked{% endif %}>
                             <span class="pp-pack-name">{% unless value contains 'Pack' %}Pack of {% endunless %}{{ value }}</span>
                             <div class="pp-pack-price-box">
                                 <span class="pp-pack-price">{{ variant_for_pack.price | money_without_trailing_zeros }}</span>
                                 {% if variant_for_pack.compare_at_price > variant_for_pack.price %}
                                    <span class="pp-pack-compare">{{ variant_for_pack.compare_at_price | money_without_trailing_zeros }}</span>
                                 {% endif %}
                             </div>
                        </label>
                    {% endfor %}
                </div>
            </div>
          {% endif %}

          <!-- Fallback for other options -->
          {% for option in product.options_with_values %}
            {% assign opt_name_down = option.name | downcase %}
            {% unless opt_name_down contains 'flavour' or opt_name_down contains 'flavor' or opt_name_down contains 'color' or opt_name_down contains 'colour' or opt_name_down contains 'size' or opt_name_down contains 'pack' %}
              <div class="pp-option-group">
                  <label class="pp-option-label">{{ option.name }}: <span class="pp-flavor-label-val">{{ option.selected_value }}</span></label>
                  <div class="pp-swatches-pack">
                      {% for value in option.values %}
                          <label class="pp-swatch-pack-item {% if option.selected_value == value %}selected{% endif %}" style="justify-content: center; width: auto; min-width: 60px;">
                               <input type="radio" name="{{ option.name }}" value="{{ value }}" {% if option.selected_value == value %}checked{% endif %}>
                               <span class="pp-pack-name">{{ value }}</span>
                          </label>
                      {% endfor %}
                  </div>
              </div>
            {% endunless %}
          {% endfor %}

          {% if product.variants.size <= 1 and product.has_only_default_variant %}
             <p style="color: red; font-size: 14px; margin-bottom: 20px; font-weight: bold; background: #ffe6e6; padding: 10px; border-radius: 8px; border: 1px solid red;">
               [Debug: No variants found. Please add options in Shopify Admin > Products > Variants.]
             </p>
          {% endif %}

          <!-- Add to Cart (Full width black pill) -->
          <button type="submit" name="add" class="pp-add-to-cart" {% unless product.available %}disabled{% endunless %}>
            {% if product.available %}
             ADD TO CART – {{ product.selected_or_first_available_variant.price | money_without_trailing_zeros }}
            {% else %}
             SOLD OUT
            {% endif %}
          </button>
          
          {% if section.settings.delivery_text != blank %}
            <p class="pp-delivery-note">{{ section.settings.delivery_text }}</p>
          {% endif %}

        {%- endform -%}

        <!-- Accordions -->
        <div class="pp-accordions">
            <details class="pp-accordion-item">
                <summary>
                    <span class="pp-accordion-title">Description</span>
                    <span class="pp-icon-chevron"><svg width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                </summary>
                <div class="pp-accordion-content">
                    {{ product.description }}
                </div>
            </details>
            
            <details class="pp-accordion-item">
                <summary>
                    <span class="pp-accordion-title">Storage Tips for Maximum Freshness</span>
                    <span class="pp-icon-chevron"><svg width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                </summary>
                <div class="pp-accordion-content">
                    <p>Keep refrigerated. Serve chilled.</p>
                </div>
            </details>

            <details class="pp-accordion-item">
                <summary>
                    <span class="pp-accordion-title">Ingredients & Nutrition</span>
                    <span class="pp-icon-chevron"><svg width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                </summary>
                <div class="pp-accordion-content">
                    <p>Carbonated Water, Sugar, Fruit Juice Concentrate...</p>
                </div>
            </details>
        </div>

      </div>
    </div>
  </div>
</section>

<!-- Hidden Judge.me Review Widget (enables "Write a Review" button) -->
<div id="judgeme_product_reviews" data-id="{{ product.id }}" style="display:none !important; visibility:hidden; height:0; overflow:hidden;"></div>

<!-- Hidden Variant Content for Rich Text -->
<div id="pp-variant-content-store" style="display: none;">
  {% for variant in product.variants %}
    <div id="variant-description-{{ variant.id }}">
      {% if variant.metafields.custom.variant_content != blank %}
        {{ variant.metafields.custom.variant_content | metafield_tag }}
      {% else %}
        {{ product.description }}
      {% endif %}
    </div>
  {% endfor %}
</div>

<style>
/* 
  Ideally move to assets/section-main-product.css
  Keeping here for instant atomic preview if desired, 
  but will move to CSS file in next step.
*/
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const section = document.querySelector('[data-section-id="{{ section.id }}"]');

  // Money Formatter
  const moneyFormat = {{ shop.money_format | json }};
  function formatMoneyMain(cents) {
    if (typeof cents == 'string') { cents = cents.replace('.',''); }
    let value = '';
    const placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
    const formatString = moneyFormat || "${{amount}}";
    function formatWithDelimiters(number, precision, thousands, decimal) {
      precision = (typeof precision == 'undefined' ? 2 : precision);
      thousands = (typeof thousands == 'undefined' ? ',' : thousands);
      decimal = (typeof decimal == 'undefined' ? '.' : decimal);
      if (isNaN(number) || number == null) { return 0; }
      number = (number/100.0).toFixed(precision);
      var parts = number.split('.'),
          dollars = parts[0].replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1' + thousands),
          cents = parts[1] ? (decimal + parts[1]) : '';
      return dollars + cents;
    }
    switch(formatString.match(placeholderRegex)[1]) {
      case 'amount': value = formatWithDelimiters(cents, 2); break;
      case 'amount_no_decimals': value = formatWithDelimiters(cents, 0); break;
      case 'amount_with_comma_separator': value = formatWithDelimiters(cents, 2, '.', ','); break;
      case 'amount_no_decimals_with_comma_separator': value = formatWithDelimiters(cents, 0, '.', ','); break;
    }
    return formatString.replace(placeholderRegex, value);
  }
  
  // Thumbnail Switcher
  const thumbnails = section.querySelectorAll('.pp-thumbnail');
  const mainImage = section.querySelector('.pp-main-image');
  
  thumbnails.forEach(thumb => {
     thumb.addEventListener('mouseenter', function() {
        thumbnails.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        mainImage.src = this.dataset.targetImage;
     });
     
     thumb.addEventListener('click', function() {
        thumbnails.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        mainImage.src = this.dataset.targetImage;
     });
  });
  
 // Variant Logic with color updates
  const variantInputs = section.querySelectorAll('input[type="radio"]');
  const priceBtn = section.querySelector('.pp-add-to-cart');
  
  // Parse variant config for dynamic background, feature color, and images
  const variantConfigData = section.dataset.variantConfig;
  let variantConfig = {};
  try {
      variantConfig = JSON.parse(variantConfigData);
      
      // Image Preloading Logic
      if (variantConfig) {
        Object.values(variantConfig).forEach(config => {
           // Preload Product Images
           if (config.images && config.images.length) {
              config.images.forEach(url => {
                 const img = new Image();
                 img.src = url;
              });
           }
           
           // Preload Feature Icons
           if (config.feature_icons && config.feature_icons.length) {
              config.feature_icons.forEach(url => {
                 const icon = new Image();
                 icon.src = url;
              });
           }
        });
      }
  } catch(e) {
      console.log('Could not parse variant config');
  }
  
  // 1. Define allVariants outside the listener for efficiency
  const allVariants = [
    {% for variant in product.variants %}
      { id: "{{ variant.id }}", options: ["{{ variant.option1 | escape }}", "{{ variant.option2 | escape }}", "{{ variant.option3 | escape }}"].filter(Boolean) },
    {% endfor %}
  ];

  // 2. Define Update Function
  function updateVariantUI(variantId) {
      // *** CRITICAL: Update the hidden form input so the correct variant gets added to cart ***
      const form = section.querySelector('form');
      if (form) {
          const hiddenInput = form.querySelector('input[name="id"]');
          if (hiddenInput) {
              hiddenInput.value = variantId;
          }
      }

      // Update URL with selected variant for bookmarking/sharing
      if (variantId) {
          const url = new URL(window.location.href);
          url.searchParams.set('variant', variantId);
          window.history.replaceState({}, '', url.toString());
      }

      // Dispatch Custom Event for other sections (like Ingredients/Nutrition, Sticky ATC) to listen to
      document.dispatchEvent(new CustomEvent('pp:variant:change', { 
          detail: { variantId: variantId } 
      }));

      if (variantId && variantConfig[variantId]) {
          const config = variantConfig[variantId];
          
          // 1. Update Background
          if (config.bg) {
              section.style.setProperty('--pp-bg', config.bg);
          }
          
          // 2. Update Feature Color
          if (config.feature) {
              section.style.setProperty('--pp-feature-color', config.feature);
          }
          
          // 2.1 Update Heading Color & Text
          if (config.heading) {
              section.style.setProperty('--pp-heading-color', config.heading);
          }
          if (config.heading_text) {
              const titleEl = section.querySelector('.pp-title');
              if (titleEl) titleEl.textContent = config.heading_text;
          }

          // 2.2 Update Feature Background Color
          if (config.feature_bg) {
              section.style.setProperty('--pp-feature-bg', config.feature_bg);
          }

          // 3. Update Images (The 4 Images)
          if (config.images && config.images.length > 0) {
              
              // Update Main Image (Set to the first one in the list)
              const mainImage = section.querySelector('.pp-main-image');
              if (mainImage) mainImage.src = config.images[0];
      
              // Update Thumbnails loop
              const thumbnails = section.querySelectorAll('.pp-thumbnail');
              config.images.forEach((imgUrl, index) => {
                  if (thumbnails[index]) {
                      // Update the click data attribute
                      thumbnails[index].dataset.targetImage = imgUrl; 
                      
                      // Update the visible thumbnail image
                      const thumbImgTag = thumbnails[index].querySelector('img');
                      if (thumbImgTag) thumbImgTag.src = imgUrl; 
                  }
              });
          }

          // 4. Update Rich Text Description
          const descriptionWrapper = section.querySelector('.pp-accordion-content');
          // Note: The unique ID must match what is generated in liquid loop
          const newContentDiv = document.getElementById(`variant-description-${variantId}`);
          
          if (descriptionWrapper && newContentDiv) {
              descriptionWrapper.innerHTML = newContentDiv.innerHTML;
          }

          // 5. Update Feature Icons
          if (config.feature_icons && config.feature_icons.length > 0) {
              const featureIcons = section.querySelectorAll('.pp-feature-icon-img');
              config.feature_icons.forEach((iconUrl, index) => {
                  if (featureIcons[index]) {
                      featureIcons[index].src = iconUrl;
                  }
              });
          }

          // 6. Update Add to Cart Button Price
          if (config.price !== undefined) {
              const priceBtn = section.querySelector('.pp-add-to-cart');
              if (priceBtn) {
                  if (config.available) {
                      priceBtn.disabled = false;
                      priceBtn.textContent = 'ADD TO CART – ' + formatMoneyMain(config.price);
                  } else {
                      priceBtn.disabled = true;
                      priceBtn.textContent = 'SOLD OUT';
                  }
              }
          }
      }
  }

  // 3. Attach Event Listeners
  variantInputs.forEach(input => {
      input.addEventListener('change', function() {
          // Update visual selected state (swatches)
          const group = this.closest('.pp-swatches-flavor') || this.closest('.pp-swatches-pack');
          if (group) {
              group.querySelectorAll('label').forEach(l => l.classList.remove('selected'));
              this.parentElement.classList.add('selected');
          }
          
          // Update Label Text (e.g. Flavour: Apple)
          const optionGroup = this.closest('.pp-option-group');
          if (optionGroup) {
              const labelVal = optionGroup.querySelector('.pp-flavor-label-val');
              if (labelVal) {
                  labelVal.textContent = this.value;
              }
          }
          
          // Resolve the CORRECT variant based on ALL selected options
          const form = this.closest('form');
          const selectedValues = form ? Array.from(form.querySelectorAll('input[type="radio"]:checked')).map(r => r.value) : [];
          
          let variantId = this.dataset.variantId; // Fallback
          
          // Find the exact variant matching all selected options
          const resolvedVariant = allVariants.find(v => {
              if (v.options.length !== selectedValues.length) return false;
              return v.options.every(opt => selectedValues.includes(opt));
          });
          
          if (resolvedVariant) {
              variantId = resolvedVariant.id;
          }
          
          // Execute UI updates
          updateVariantUI(variantId);
      });
  });

  // 4. Initial Run on Page Load (Fix for correct initial state)
  // We need to determine the currently selected variant based on the checked inputs
  const initialForm = section.querySelector('form');
  if (initialForm) {
      const initialSelectedValues = Array.from(initialForm.querySelectorAll('input[type="radio"]:checked')).map(r => r.value);
      const initialResolvedVariant = allVariants.find(v => {
          if (v.options.length !== initialSelectedValues.length) return false;
          return v.options.every(opt => initialSelectedValues.includes(opt));
      });

      if (initialResolvedVariant) {
          updateVariantUI(initialResolvedVariant.id);
      }
  } // Accordion Logic (Exclusive Opening)
  const productAccordions = section.querySelectorAll('.pp-accordions details');
  productAccordions.forEach((targetDetail) => {
    targetDetail.addEventListener('click', (e) => {
       // Check if we are about to open it (it is currently closed)
       if (!targetDetail.open) { 
          productAccordions.forEach((detail) => {
             // Close all other open details
             if (detail !== targetDetail && detail.open) {
                detail.removeAttribute('open');
             }
          });
       }
    });
  });
});
</script>

{% schema %}
{
  "name": "Main Product (Pixel)",
  "settings": [
    {
      "type": "text",
      "id": "delivery_text",
      "label": "Delivery Text",
      "default": "Delivery expected by 12–15 January"
    }
  ],
  "presets": [
    {
      "name": "Main Product (Pixel)"
    }
  ]
}
{% endschema %}
