{% schema %}
{
  "name": "Ingredients & Nutrition",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Know What You're Sipping"
    },
    {
      "type": "color",
      "id": "section_bg",
      "label": "Section Background",
      "default": "#FFF5E6"
    },
    {
      "type": "color",
      "id": "marquee_bg",
      "label": "Marquee Background",
      "default": "#E2981A"
    },
    {
        "type": "color",
        "id": "border_color",
        "label": "Table Border Color",
        "default": "#13785A"
    },
    {
        "type": "color",
        "id": "footer_color",
        "label": "Footer Text Color",
        "default": "#000000"
    }
  ],
  "blocks": [
    {
      "type": "ingredient",
      "name": "Ingredient",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Ingredient Image"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Ingredient Name",
          "default": "Ingredient Name"
        }
      ]
    },
    {
      "type": "marquee_item",
      "name": "Marquee Text",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "No Artificial Sweeteners"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Ingredients & Nutrition",
      "blocks": [
        {
          "type": "ingredient",
          "settings": { "title": "Carbonated water" }
        },
        {
          "type": "ingredient",
          "settings": { "title": "Real Mango Extract" }
        },
        {
          "type": "ingredient",
          "settings": { "title": "Lime extract" }
        },
        {
          "type": "ingredient",
          "settings": { "title": "Prebiotic fibre\n(plant-based inulin)" }
        },
        {
          "type": "ingredient",
          "settings": { "title": "Natural sweeteners" }
        },
        {
          "type": "ingredient",
          "settings": { "title": "Himalayan rock salt" }
        },
        {
          "type": "ingredient",
          "settings": { "title": "Natural flavours" }
        },
        {
           "type": "marquee_item",
           "settings": { "text": "No Artificial Sweeteners" }
        },
        {
           "type": "marquee_item",
           "settings": { "text": "No Preservatives" }
        },
        {
           "type": "marquee_item",
           "settings": { "text": "No Gluten" }
        },
        {
           "type": "marquee_item",
           "settings": { "text": "No Artificial Colours" }
        }
      ]
    }
  ]
}
{% endschema %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap');

  .ing-section {
    /* === CSS Variables for DRY Principles === */
    --section-bg: {{ section.settings.section_bg }};
    --nut-color: {{ product.selected_or_first_available_variant.metafields.custom.nutrition_color.value | default: product.metafields.custom.nutrition_color.value | default: section.settings.border_color }};
    --font-primary: 'Plus Jakarta Sans', sans-serif;
    --font-display: 'Playfair Display', serif;
    --border-thin: 2px;
    --border-thick: 4px;
    --spacing-sm: 10px;
    --spacing-md: 15px;
    --spacing-lg: 30px;
    --spacing-xl: 60px;
    --container-max-width: 1200px;
    
    /* Section Styles */
    background-color: var(--section-bg);
    padding-top: 140px;
    font-family: var(--font-primary);
    position: relative;
    padding-bottom: 60px; /* Reduced since marquee is no longer absolute */
    margin-top: -70px; /* Remove gap with section above */
  }

  .ing-container {
    max-width: var(--container-max-width);
    margin: 0 auto 0;
    padding: 0 var(--spacing-lg);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-xl);
    position: relative;
    z-index: 2;
  }

  /* Left Side: Ingredients */
  .ing-left {
    flex: 1;
    max-width: 750px;
    margin-top: -70px;
    margin-left: -30px; /* Shift content to the left */
  }

  .ing-heading {
    font-family: var(--font-display);
    font-size: 63px;
    font-weight: 600;
    color: #000;
    margin-bottom: var(--spacing-xl);
    line-height: 1.1;
    letter-spacing: -1px;
    text-align: center;
  }

  .ing-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px 55px; /* Increased column gap */
  }

  .ing-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 140px; /* Increased for single-line text */
    text-align: center;
  }

  .ing-circle {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    background-color: #E0E0E0;
    margin-bottom: var(--spacing-md);
    overflow: hidden;
  }
  
  .ing-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }

  .ing-label {
    font-size: 17px;
    font-weight: 500;
    color: #333;
    line-height: 1.3;
  }

  /* Right Side: Nutrition Facts */
  .ing-right {
    width: 420px; /* Increased from 380px */
    flex-shrink: 0;
    margin-right: -100px; /* Shift card to the right */
  }

  .nut-card {
    background-color: #fff;
    border: var(--border-thick) solid var(--nut-color);
    border-radius: 12px;
    padding: var(--spacing-lg);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    min-height: auto;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: relative;
    z-index: 2;
  }

  .nut-title {
    font-family: var(--font-primary);
    font-size: 26px;
    font-weight: 800;
    color: var(--nut-color) !important;
    margin-bottom: 5px;
    letter-spacing: -0.5px;
    line-height: 1.2;
    border-bottom: var(--border-thin) solid var(--nut-color);
    padding-bottom: 5px;
    width: 100%;
    display: block;
  }

  .nut-serving {
    font-size: 17px;
    font-weight: 700;
    color: var(--nut-color) !important;
    margin-bottom: 10px;
    border-bottom: 14px solid var(--nut-color); /* Added 4px bottom border */
    padding-bottom: 10px; /* Added padding */
    width: 100%;
    display: block;
  }

  .nut-divider-thick {
    height: 12px;
    background-color: var(--nut-color);
    width: 100%;
    margin-top: 5px;
    margin-bottom: 12px;
  }

  .nut-divider-thin {
    height: 2px;
    background-color: var(--nut-color) !important;
    width: 100%;
    margin-top: 6px;
    margin-bottom: 10px;
    display: block;
    opacity: 1;
    border: none;
  }

  .nut-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 9px 0;
    border-bottom: var(--border-thin) solid var(--nut-color);
    font-size: 15px;
    font-weight: 700;
    color: var(--nut-color) !important;
  }
   
  .nut-row.no-border {
      border-bottom: none;
  }
   
  .nut-row.thick-border {
    border-bottom: var(--border-thick) solid var(--nut-color);
  }

  .nut-label {
    font-weight: 700;
  }
  
  .nut-sub-label {
      padding-left: 15px; 
      font-weight: 500;
  }

  .nut-value {
    font-weight: 700;
  }

  .nut-calories {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 24px;
    font-weight: 800;
    padding: 2px 0 8px;
    border-bottom: var(--border-thick) solid var(--nut-color);
    margin-bottom: 4px;
    color: var(--nut-color) !important;
  }

  .nut-daily-value {
    text-align: right;
    font-size: 19px;
    font-weight: 700;
    margin-bottom: 5px;
    padding-top: 4px;
  }

  .nut-footer {
    font-size: 14px;
    margin-top: var(--spacing-md);
    color: {{ section.settings.footer_color }};
    line-height: 1.3;
  }

  /* Marquee Section */
  .marquee-wrapper {
    background: linear-gradient(90deg, #D29100 0%, #FFD26C 50%, #D29100 100%);
    padding: 28px 0;
    width: 80%;
    overflow: hidden;
    position: relative; /* Standard flow */
    margin-top: -120px; /* Spacing below card */
    white-space: nowrap;
    z-index: 1;
    transform: none;
  }

  .marquee-content {
    display: inline-block;
    animation: marquee 20s linear infinite;
  }

  .marquee-item {
    display: inline-block;
    color: #000;
    font-size: 18px;
    font-weight: 700;
    margin: 0 30px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .marquee-dot {
      display: inline-block;
      margin: 0 10px;
  }

  @keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  /* Responsive Design */

  /* Small Laptops (13-inch screens) */
  @media (max-width: 1366px) and (min-width: 1025px) {
    .ing-container {
      max-width: 100%;
      padding: 0 20px;
      gap: 30px;
    }

    .ing-left {
      margin-left: 0;
    }

    .ing-right {
      width: 350px;
      margin-right: 0;
    }

    .marquee-wrapper {
      width: 90%;
    }
  }

  @media (max-width: 1024px) {
    .ing-container {
      flex-direction: column;
      align-items: center;
      gap: 50px;
      padding: 0 10px; /* Reduced side padding */
    }

    .ing-left {
      width: 100%; /* Force full width */
      max-width: 100%;
      text-align: center;
      margin-left: 0; /* Reset desktop offset */
    }
    
    .ing-heading {
        text-align: center;
        font-size: 42px;
    }

    .ing-grid {
      justify-content: center;
    }

    .ing-right {
      width: 100%;
      max-width: 420px;
      margin-right: 0;
    }
  }

  @media (max-width: 768px) {
    .ing-heading {
      font-size: 32px;
      margin-bottom: 40px;
    }

    .ing-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px 0;
      width: 100%; /* Force full width */
    }

    .ing-item {
      flex: 0 0 33.33%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .ing-circle {
        width: 90px;
        height: 90px;
    }

    .ing-label {
        font-size: 13px;
        line-height: 1.2;
    }

    .nut-card {
      width: 100%;
      max-width: 350px;
      margin: 0 auto; /* Explicitly center */
    }
    
    .marquee-item {
        font-size: 15px;
        margin: 0 15px;
    }
  }
</style>

<div class="ing-section">
  <div class="ing-container">
    
    <!-- Left: Ingredients -->
    <div class="ing-left">
      <h2 class="ing-heading">{{ section.settings.heading }}</h2>
      
      <div class="ing-grid">
        {% for block in section.blocks %}
          {% if block.type == 'ingredient' %}
            {% assign ing_image = block.settings.image %}
            {% assign ing_title = block.settings.title %}
            
            {% comment %} Conditional Overrides for 2nd and Last Item {% endcomment %}
            {% assign variant_meta = product.selected_or_first_available_variant.metafields.custom %}
            
            {% if forloop.index == 2 %}
                 {% if variant_meta.ingredient_2_image.value != blank %}
                      {% assign ing_image = variant_meta.ingredient_2_image.value %}
                 {% endif %}
                 {% if variant_meta.ingredient_2_text.value != blank %}
                      {% assign ing_title = variant_meta.ingredient_2_text.value %}
                 {% endif %}
            {% endif %}
            
            {% assign ingredients_count = 0 %}
            {% for b in section.blocks %}
               {% if b.type == 'ingredient' %}{% assign ingredients_count = ingredients_count | plus: 1 %}{% endif %}
            {% endfor %}
            
            {% comment %} We need to know if this is the last INGREDIENT block, checking section.blocks loop directly is risky if mixed types {% endcomment %}
            {% comment %} But here forloop.rindex0 doesn't distinguish block types. Let's rely on standard count or just check if it's the 9th item etc. {% endcomment %}
            {% comment %} Safer: assume the structure is consistently only ingredient items in this loop (filtered by type)
              Wait, the loop iterates all blocks. The type check filters. 
              The 'forloop' object refers to the blocks loop.
              We can't rely on forloop.last if there are marquee items after. 
              Let's use a counter.
            {% endcomment %}
          {% endif %}
        {% endfor %}
        
        {% assign ing_counter = 0 %}
        {% for block in section.blocks %}
          {% if block.type == 'ingredient' %}
            {% assign ing_counter = ing_counter | plus: 1 %}
          {% endif %}
        {% endfor %}
        
        {% assign current_ing_index = 0 %}
        {% for block in section.blocks %}
          {% if block.type == 'ingredient' %}
            {% assign current_ing_index = current_ing_index | plus: 1 %}
            
            {% assign ing_image = block.settings.image %}
            {% assign ing_title = block.settings.title %}
             {% assign variant_meta = product.selected_or_first_available_variant.metafields.custom %}
            
            {% if current_ing_index == 2 %}
                 {% if variant_meta.ingredient_2_image.value != blank %}
                      {% assign ing_image = variant_meta.ingredient_2_image.value %}
                 {% endif %}
                 {% if variant_meta.ingredient_2_text.value != blank %}
                      {% assign ing_title = variant_meta.ingredient_2_text.value %}
                 {% endif %}
            {% endif %}
            
            {% if current_ing_index == ing_counter %}
                 {% if variant_meta.ingredient_last_image.value != blank %}
                      {% assign ing_image = variant_meta.ingredient_last_image.value %}
                 {% endif %}
                 {% if variant_meta.ingredient_last_text.value != blank %}
                      {% assign ing_title = variant_meta.ingredient_last_text.value %}
                 {% endif %}
            {% endif %}

            <div class="ing-item" data-index="{{ current_ing_index }}" data-is-second="{% if current_ing_index == 2 %}true{% endif %}" data-is-last="{% if current_ing_index == ing_counter %}true{% endif %}">
              <div class="ing-circle">
                {% if ing_image != blank %}
                  {{ ing_image | image_url: width: 200 | image_tag: loading: 'lazy' }}
                {% endif %}
              </div>
              <div class="ing-label">{{ ing_title | newline_to_br }}</div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Right: Nutrition Facts -->
    <div class="ing-right">
      <div class="nut-card">
        <div class="nut-title">NUTRITION FACTS</div>
        <!-- Removed separate divider -->
        <div class="nut-serving">Serving Size &nbsp; 1 Can (350ml)</div>
        <!-- Removed thick divider as it's now part of serving class -->
        
        <div style="font-size: 13px; font-weight: 700; margin-bottom: 5px; color: var(--nut-color) !important;">Amount Per Serving</div>
        <div class="nut-calories">
          <span>Calories</span>
          <span>35 kcal</span>
        </div>
        
         <div class="nut-daily-value" style="color: var(--nut-color) !important;">% Daily Value*</div>
         <div style="border-bottom: 1px solid #13785A; margin-bottom: 5px;"></div>

        <div class="nut-row" style="border-top: 2px solid var(--nut-color);">
          <span class="nut-label">Total Fat <span style="font-weight:500">0.06g</span></span>
          <span class="nut-value">0.06</span>
        </div>
        
        <div class="nut-row">
          <span class="nut-label">Sodium <span style="font-weight:500">0.50mg</span></span>
          <span class="nut-value">0.50</span>
        </div>
        
        <div class="nut-row">
          <span class="nut-label">Total Carbohydrates <span style="font-weight:500">5.22g</span></span>
          <span class="nut-value">5.22</span>
        </div>
        
        <div class="nut-row">
          <span class="nut-sub-label">Fiber 1.71g</span>
          <span class="nut-value">1.71</span>
        </div>
        
        <div class="nut-row">
          <span class="nut-sub-label">Total Sugar 3.47g</span>
          <span class="nut-value">3.47</span>
        </div>
        
        <div class="nut-row">
          <span class="nut-sub-label">Added Sugar 0g</span>
          <span class="nut-value">0.00</span>
        </div>
        
        <div class="nut-row thick-border">
          <span class="nut-label">Protein <span style="font-weight:500">0.23g</span></span>
          <span class="nut-value">0.23</span>
        </div>

        <div class="nut-footer">
          Not a significant source of the information provided
        </div>
      </div>
    </div>

  </div>

  <!-- Marquee -->
  <div class="marquee-wrapper">
    <div class="marquee-content">
      <!-- Duplicate content to ensure seamless scrolling -->
      {% for i in (1..4) %}
        {% for block in section.blocks %}
          {% if block.type == 'marquee_item' %}
            <span class="marquee-item">&#9679;&nbsp;&nbsp; {{ block.settings.text }}</span>
          {% endif %}
        {% endfor %}
      {% endfor %}
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const sectionContainer = document.querySelector('.ing-section');
    if (!sectionContainer) return;

    // Variant data for dynamic updates
    const variants = [
      {% for variant in product.variants %}
        {
          id: "{{ variant.id }}",
          color: "{{ variant.metafields.custom.nutrition_color.value | default: product.metafields.custom.nutrition_color.value | default: section.settings.border_color }}",
          ing2_img: "{% if variant.metafields.custom.ingredient_2_image.value %}{{ variant.metafields.custom.ingredient_2_image.value | image_url: width: 200 }}{% endif %}",
          ing2_text: `{{ variant.metafields.custom.ingredient_2_text.value | newline_to_br }}`,
          ingLast_img: "{% if variant.metafields.custom.ingredient_last_image.value %}{{ variant.metafields.custom.ingredient_last_image.value | image_url: width: 200 }}{% endif %}",
          ingLast_text: `{{ variant.metafields.custom.ingredient_last_text.value | newline_to_br }}`
        },
      {% endfor %}
    ];

    // Listen for custom event dispatched by main-product.liquid
    document.addEventListener('pp:variant:change', function(e) {
        if (!e.detail || !e.detail.variantId) return;
        
        const variantId = String(e.detail.variantId);
        const match = variants.find(v => String(v.id) === variantId);
        if (!match) return;

        // Update nutrition card color
        sectionContainer.style.setProperty('--nut-color', match.color);

        // Update 2nd Ingredient Item
        const secondItem = sectionContainer.querySelector('.ing-item[data-is-second="true"]');
        if (secondItem) {
            if (match.ing2_img) {
                const img = secondItem.querySelector('.ing-circle img');
                if (img) {
                    img.src = match.ing2_img;
                } else {
                    const circle = secondItem.querySelector('.ing-circle');
                    if (circle) {
                        const newImg = document.createElement('img');
                        newImg.src = match.ing2_img;
                        newImg.loading = 'lazy';
                        circle.appendChild(newImg);
                    }
                }
            }
            if (match.ing2_text) {
                const label = secondItem.querySelector('.ing-label');
                if (label) label.innerHTML = match.ing2_text;
            }
        }

        // Update Last Ingredient Item
        const lastItem = sectionContainer.querySelector('.ing-item[data-is-last="true"]');
        if (lastItem) {
            if (match.ingLast_img) {
                const img = lastItem.querySelector('.ing-circle img');
                if (img) {
                    img.src = match.ingLast_img;
                } else {
                    const circle = lastItem.querySelector('.ing-circle');
                    if (circle) {
                        const newImg = document.createElement('img');
                        newImg.src = match.ingLast_img;
                        newImg.loading = 'lazy';
                        circle.appendChild(newImg);
                    }
                }
            }
            if (match.ingLast_text) {
                const label = lastItem.querySelector('.ing-label');
                if (label) label.innerHTML = match.ingLast_text;
            }
        }
    });
  });
</script>
